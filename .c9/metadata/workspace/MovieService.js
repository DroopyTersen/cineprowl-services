{"filter":false,"title":"MovieService.js","tooltip":"/MovieService.js","undoManager":{"mark":100,"position":100,"stack":[[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":35},"end":{"row":5,"column":36}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":5,"column":35},"end":{"row":5,"column":36}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":35},"end":{"row":5,"column":36}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":36},"end":{"row":5,"column":37}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":37},"end":{"row":5,"column":38}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":38},"end":{"row":5,"column":39}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":39},"end":{"row":5,"column":40}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":40},"end":{"row":5,"column":41}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":41},"end":{"row":5,"column":42}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":42},"end":{"row":5,"column":43}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":43},"end":{"row":5,"column":44}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":44},"end":{"row":5,"column":45}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":45},"end":{"row":5,"column":46}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":46},"end":{"row":5,"column":47}},"text":"\""}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":23},"end":{"row":5,"column":24}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":24},"end":{"row":5,"column":25}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":49},"end":{"row":5,"column":50}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":50},"end":{"row":5,"column":51}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":5,"column":50},"end":{"row":5,"column":51}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":5,"column":50},"end":{"row":5,"column":51}},"text":","}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":216,"column":0},"end":{"row":216,"column":4}},"text":"\t}];"},{"action":"removeLines","range":{"start":{"row":187,"column":0},"end":{"row":216,"column":0}},"nl":"\n","lines":["\t\t$project: {","\t\t\t'casts.cast.name': 1,","\t\t\t'casts.cast.id': 1,","\t\t\t'casts.cast.profile_path': 1,","\t\t\ttitle: 1","\t\t}","\t}, {","\t\t$unwind: \"$casts.cast\"","\t}, {","\t\t$group: {","\t\t\t_id: {","\t\t\t\tid: \"$casts.cast.id\",","\t\t\t\tname: \"$casts.cast.name\",","\t\t\t\tprofile_path: \"$casts.cast.profile_path\"","\t\t\t},","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t},","\t\t}","\t}, {","\t\t$match: {","\t\t\t\"_id.name\": startsWithRegex(search)","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}","\t}, {","\t\t$limit: limit || 5"]},{"action":"removeText","range":{"start":{"row":186,"column":24},"end":{"row":186,"column":26}},"text":"[{"},{"action":"removeText","range":{"start":{"row":186,"column":24},"end":{"row":187,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":186,"column":24},"end":{"row":186,"column":25}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":25},"end":{"row":186,"column":26}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":24},"end":{"row":186,"column":26}},"text":"ag"},{"action":"insertText","range":{"start":{"row":186,"column":24},"end":{"row":186,"column":34}},"text":"aggregates"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":34},"end":{"row":186,"column":35}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":35},"end":{"row":186,"column":36}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":36},"end":{"row":186,"column":37}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":37},"end":{"row":186,"column":38}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":35},"end":{"row":186,"column":38}},"text":"sea"},{"action":"insertText","range":{"start":{"row":186,"column":35},"end":{"row":186,"column":49}},"text":"searchActors()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":48},"end":{"row":186,"column":50}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":49},"end":{"row":186,"column":50}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":50},"end":{"row":186,"column":51}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":51},"end":{"row":186,"column":52}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":52},"end":{"row":186,"column":53}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":53},"end":{"row":186,"column":54}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":54},"end":{"row":186,"column":55}},"text":"h"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":54},"end":{"row":186,"column":55}},"text":"h"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":53},"end":{"row":186,"column":54}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":52},"end":{"row":186,"column":53}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":51},"end":{"row":186,"column":52}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":50},"end":{"row":186,"column":51}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":49},"end":{"row":186,"column":50}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":48},"end":{"row":186,"column":50}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":48},"end":{"row":186,"column":49}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":49},"end":{"row":186,"column":50}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":50},"end":{"row":186,"column":51}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":51},"end":{"row":186,"column":52}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":52},"end":{"row":186,"column":53}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":53},"end":{"row":186,"column":54}},"text":"h"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":54},"end":{"row":186,"column":55}},"text":","}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":55},"end":{"row":186,"column":56}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":56},"end":{"row":186,"column":57}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":57},"end":{"row":186,"column":58}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":58},"end":{"row":186,"column":59}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":59},"end":{"row":186,"column":60}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":60},"end":{"row":186,"column":61}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":61},"end":{"row":186,"column":62}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":186,"column":62},"end":{"row":186,"column":63}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":186,"column":62},"end":{"row":186,"column":63}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":218,"column":0},"end":{"row":218,"column":4}},"text":"\t}];"},{"action":"removeLines","range":{"start":{"row":193,"column":0},"end":{"row":218,"column":0}},"nl":"\n","lines":["\t\t$project: {","\t\t\t'casts.cast.name': 1,","\t\t\t'casts.cast.id': 1,","\t\t\t'casts.cast.profile_path': 1,","\t\t\ttitle: 1","\t\t}","\t}, {","\t\t$unwind: \"$casts.cast\"","\t}, {","\t\t$group: {","\t\t\t_id: {","\t\t\t\tid: \"$casts.cast.id\",","\t\t\t\tname: \"$casts.cast.name\",","\t\t\t\tprofile_path: \"$casts.cast.profile_path\"","\t\t\t},","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t},","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}","\t}, {","\t\t$limit: count || 200"]},{"action":"removeText","range":{"start":{"row":192,"column":24},"end":{"row":192,"column":26}},"text":"[{"},{"action":"removeText","range":{"start":{"row":192,"column":24},"end":{"row":193,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":192,"column":24},"end":{"row":192,"column":25}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":25},"end":{"row":192,"column":26}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":192,"column":24},"end":{"row":192,"column":26}},"text":"ag"},{"action":"insertText","range":{"start":{"row":192,"column":24},"end":{"row":192,"column":34}},"text":"aggregates"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":34},"end":{"row":192,"column":35}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":35},"end":{"row":192,"column":36}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":36},"end":{"row":192,"column":37}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":192,"column":35},"end":{"row":192,"column":37}},"text":"ac"},{"action":"insertText","range":{"start":{"row":192,"column":35},"end":{"row":192,"column":43}},"text":"actors()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":42},"end":{"row":192,"column":44}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":192,"column":42},"end":{"row":192,"column":44}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":42},"end":{"row":192,"column":43}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":43},"end":{"row":192,"column":44}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":44},"end":{"row":192,"column":45}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":192,"column":42},"end":{"row":192,"column":45}},"text":"cou"},{"action":"insertText","range":{"start":{"row":192,"column":42},"end":{"row":192,"column":47}},"text":"count"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":47},"end":{"row":192,"column":48}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":192,"column":48},"end":{"row":192,"column":49}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":192,"column":49},"end":{"row":192,"column":50}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":145,"column":0},"end":{"row":145,"column":4}},"text":"\t}];"},{"action":"removeLines","range":{"start":{"row":128,"column":0},"end":{"row":145,"column":0}},"nl":"\n","lines":["\t\t$project: {","\t\t\tgenres: 1,","\t\t\ttitle: 1","\t\t}","\t}, {","\t\t$unwind: \"$genres\"","\t}, {","\t\t$group: {","\t\t\t_id: \"$genres.name\",","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t}","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}"]},{"action":"removeText","range":{"start":{"row":127,"column":23},"end":{"row":127,"column":26}},"text":" [{"},{"action":"removeText","range":{"start":{"row":127,"column":23},"end":{"row":128,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":127,"column":23},"end":{"row":127,"column":24}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":24},"end":{"row":127,"column":25}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":25},"end":{"row":127,"column":26}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":26},"end":{"row":127,"column":27}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":26},"end":{"row":127,"column":27}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":26},"end":{"row":127,"column":27}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":24},"end":{"row":127,"column":27}},"text":"agg"},{"action":"insertText","range":{"start":{"row":127,"column":24},"end":{"row":127,"column":34}},"text":"aggregates"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":34},"end":{"row":127,"column":35}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":35},"end":{"row":127,"column":36}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":36},"end":{"row":127,"column":37}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":37},"end":{"row":127,"column":38}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":35},"end":{"row":127,"column":38}},"text":"gen"},{"action":"insertText","range":{"start":{"row":127,"column":35},"end":{"row":127,"column":43}},"text":"genres()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":42},"end":{"row":127,"column":44}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":43},"end":{"row":127,"column":44}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":42},"end":{"row":127,"column":44}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":42},"end":{"row":127,"column":43}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":127,"column":43},"end":{"row":127,"column":44}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":44},"end":{"row":128,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":128,"column":30},"end":{"row":128,"column":46}},"text":"aggregateActions"},{"action":"insertText","range":{"start":{"row":128,"column":30},"end":{"row":128,"column":31}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":128,"column":31},"end":{"row":128,"column":32}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":128,"column":30},"end":{"row":128,"column":32}},"text":"ag"},{"action":"insertText","range":{"start":{"row":128,"column":30},"end":{"row":128,"column":40}},"text":"aggregates"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":128,"column":40},"end":{"row":128,"column":41}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":128,"column":41},"end":{"row":128,"column":42}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":128,"column":41},"end":{"row":128,"column":42}},"text":"g"},{"action":"insertText","range":{"start":{"row":128,"column":41},"end":{"row":128,"column":49}},"text":"genres()"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":127,"column":0},"end":{"row":127,"column":44}},"text":"\tvar aggregateActions = aggregates.genres();"},{"action":"removeText","range":{"start":{"row":126,"column":44},"end":{"row":127,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":138,"column":0},"end":{"row":139,"column":0}},"nl":"\n","lines":[""]}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":219,"column":0},"end":{"row":219,"column":30}},"text":"module.exports = MovieService;"},{"action":"removeLines","range":{"start":{"row":0,"column":0},"end":{"row":219,"column":0}},"nl":"\n","lines":["\"use strict\";","var mongo = require(\"droopy-mongo\"),","\tconfig = require('./config'),","\tmodels = require(\"CineProwl-Models\"),","\tq = require(\"q\"),","\taggregates = require(\"./movieservice/aggregates\"),","\tdao;","","","var MovieService = function(url) {","\turl = url || config.mongo.url;","\tdao = new mongo.MongoDao(url);","\tthis.movies = dao.collection(\"movies\");","\tthis.dao = dao;","};","","MovieService.prototype._query = function(queryObject, sort, displayed, size) {","\tvar options = {","\t\tsort: sort || {","\t\t\taddedToDb: -1","\t\t},","\t\tskip: displayed || 0,","\t\tlimit: size || 20","\t};","\tvar query = new mongo.MongoQuery(queryObject, models.ThinMovie.fields, options);","\treturn this._find(query, models.ThinMovie);","};","","MovieService.prototype._find = function(mongoQuery, Model) {","\treturn this.movies.mongoFind(mongoQuery)","\t\t.then(function(results) {","\t\t\tif (Model) {","\t\t\t\treturn results.map(function(result) {","\t\t\t\t\treturn new Model(result);","\t\t\t\t});","\t\t\t} else {","\t\t\t\treturn results;","\t\t\t}","\t\t});","};","","MovieService.prototype.findOne = function(query) {","\treturn this.movies.findOne(query)","\t\t.then(function(result) {","\t\t\treturn models.FullMovie.create(result);","\t\t});","};","","MovieService.prototype.getById = function(id) {","\tif (typeof id === \"string\") {","\t\tid = parseInt(id, 10);","\t}","\treturn this.findOne({","\t\tid: id","\t});","};","","MovieService.prototype.checkIfExists = function(query) {","\treturn this.movies.checkIfExists(query);","};","","MovieService.prototype.query = function(queryObject, sort, displayed, size) {","\treturn this._query(queryObject, sort, displayed, size);","};","","//WRITE ACTIONS","MovieService.prototype.insert = function(movie) {","\tvar self = this;","\treturn this.checkIfExists({","\t\tid: movie.id","\t})","\t\t.then(function(exists) {","\t\t\tif (!exists) {","\t\t\t\tmovie.addedToDb = new Date();","\t\t\t\treturn self.movies.insert(movie)","\t\t\t\t\t.then(function(movies){","\t\t\t\t\t\treturn movies.length ? movies[0] : null;","\t\t\t\t\t});","\t\t\t} else {","\t\t\t\tthrow new Error(\"Movie already exists\");","\t\t\t}","\t\t});","};","","MovieService.prototype.insertFromMovieDb = function(movie) {","","};","","MovieService.prototype.update = function(movieId, update) {","\treturn this.movies.updateOne({","\t\tid: movieId","\t}, update);","};","","MovieService.prototype.remove = function(movieId) {","\tif (typeof movieId === \"string\") {","\t\tmovieId = parseInt(movieId, 10);","\t}","\treturn this.movies.remove({","\t\tid: movieId","\t});","};","","MovieService.prototype.setTag = function(movieId, tag, value) {","\tvar updateObj = {};","\tupdateObj['tags.' + tag] = value;","\treturn this.update(movieId, updateObj);","};","","MovieService.prototype.toggleWatched = function(movieId, watched) {","\treturn this.update(movieId, {","\t\twatched: watched","\t});","};","","//HELPERS","MovieService.prototype.filmography = function(actorId) {","\tvar queryObj = {","\t\t\"casts.cast.id\": actorId","\t};","\tvar sort = {","\t\t\"release_date\": -1","\t};","\treturn this._query(queryObj, sort, 0, 2000);","};","","MovieService.prototype.genres = function() {","\treturn this.movies.aggregate(aggregates.genres());","};","","var startsWithRegex = function(search) {","\tvar pattern = \"^\" + search + \"|\\\\s\" + search;","\treturn {","\t\t\"$regex\": pattern,","\t\t\"$options\": \"i\"","\t};","};","","MovieService.prototype.search = function(search, limit) {","\tvar self = this;","\tvar searchResults = {","\t\tmovies: [],","\t\tpeople: []","\t};","","\treturn self.searchMovies(search, 5)","\t\t.then(function(movieResults) {","\t\t\tconsole.log(\"movieResults\");","","\t\t\tsearchResults.movies = movieResults;","\t\t\treturn self.searchActors(search, 5);","\t\t})","\t\t.then(function(actorResults) {","\t\t\tsearchResults.people = actorResults;","\t\t\treturn searchResults;","\t\t});","};","","MovieService.prototype.searchMovies = function(search, limit) {","\treturn this._query({","\t\ttitle: startsWithRegex(search)","\t}, null, 0, 5);","};","","MovieService.prototype.searchActors = function(search, limit) {","\tvar aggregateActions = aggregates.searchActors(search, limit);","","\treturn this.movies.aggregate(aggregateActions);","};","","MovieService.prototype.actors = function(count) {","\tvar aggregateActions = aggregates.actors(count);","","\treturn this.movies.aggregate(aggregateActions);","};","","MovieService.prototype._tagsQuery = function(tag) {","\tvar query = {};","\tquery[tag] = {","\t\t$ne: null","\t};","","\tvar options = {","\t\tsort: {}","\t};","\toptions.sort[tag] = -1;","","\tvar fields = models.ThinMovie.fields;","\treturn this._find(new mongo.MongoQuery(query, fields, options), models.ThinMovie);","};","","MovieService.prototype.favorites = function() {","\treturn this._tagsQuery(\"tags.favorited\");","};","","MovieService.prototype.queue = function() {","\treturn this._tagsQuery(\"tags.queued\");","};","","MovieService.prototype.stats = function() {","\t//total movies","\t//total watched","\t//total unwatched","\t//watched/unwatched by genre","\tvar query = { id : { $ne: null}};","\treturn this.query(query, null, 0, 2000)","\t\t.then(function(allMovies){","\t\t\tvar stats = {","\t\t\t\tcount: allMovies.length","\t\t\t};","\t\t\tvar unwatched = allMovies.filter(function(movie) {","\t\t\t\treturn movie.watched === false;\t","\t\t\t});","\t\t\tstats.unwatched = unwatched.length;","\t\t\tstats.watched = stats.count - stats.unwatched;","\t\t\treturn stats;","\t\t});","","}"]},{"action":"insertText","range":{"start":{"row":0,"column":0},"end":{"row":0,"column":13}},"text":"\"use strict\";"},{"action":"insertText","range":{"start":{"row":0,"column":13},"end":{"row":1,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1,"column":0},"end":{"row":284,"column":0}},"lines":["var mongo = require(\"droopy-mongo\"),","\tconfig = require('./config'),","\tmodels = require(\"CineProwl-Models\"),","\tq = require(\"q\"),","\taggregates = require(\"./movieservice/aggregates\"),","\tdao;","","","var MovieService = function(url) {","\turl = url || config.mongo.url;","\tdao = new mongo.MongoDao(url);","\tthis.movies = dao.collection(\"movies\");","\tthis.dao = dao;","};","","MovieService.prototype._query = function(queryObject, sort, displayed, size) {","\tvar options = {","\t\tsort: sort || {","\t\t\taddedToDb: -1","\t\t},","\t\tskip: displayed || 0,","\t\tlimit: size || 20","\t};","\tvar query = new mongo.MongoQuery(queryObject, models.ThinMovie.fields, options);","\treturn this._find(query, models.ThinMovie);","};","","MovieService.prototype._find = function(mongoQuery, Model) {","\treturn this.movies.mongoFind(mongoQuery)","\t\t.then(function(results) {","\t\t\tif (Model) {","\t\t\t\treturn results.map(function(result) {","\t\t\t\t\treturn new Model(result);","\t\t\t\t});","\t\t\t}","\t\t\telse {","\t\t\t\treturn results;","\t\t\t}","\t\t});","};","","MovieService.prototype.findOne = function(query) {","\treturn this.movies.findOne(query)","\t\t.then(function(result) {","\t\t\treturn models.FullMovie.create(result);","\t\t});","};","","MovieService.prototype.getById = function(id) {","\tif (typeof id === \"string\") {","\t\tid = parseInt(id, 10);","\t}","\treturn this.findOne({","\t\tid: id","\t});","};","","MovieService.prototype.checkIfExists = function(query) {","\treturn this.movies.checkIfExists(query);","};","","MovieService.prototype.query = function(queryObject, sort, displayed, size) {","\treturn this._query(queryObject, sort, displayed, size);","};","","//WRITE ACTIONS","MovieService.prototype.insert = function(movie) {","\tvar self = this;","\treturn this.checkIfExists({","\t\t\tid: movie.id","\t\t})","\t\t.then(function(exists) {","\t\t\tif (!exists) {","\t\t\t\tmovie.addedToDb = new Date();","\t\t\t\treturn self.movies.insert(movie)","\t\t\t\t\t.then(function(movies) {","\t\t\t\t\t\treturn movies.length ? movies[0] : null;","\t\t\t\t\t});","\t\t\t}","\t\t\telse {","\t\t\t\tthrow new Error(\"Movie already exists\");","\t\t\t}","\t\t});","};","","MovieService.prototype.insertFromMovieDb = function(movie) {","","};","","MovieService.prototype.update = function(movieId, update) {","\treturn this.movies.updateOne({","\t\tid: movieId","\t}, update);","};","","MovieService.prototype.remove = function(movieId) {","\tif (typeof movieId === \"string\") {","\t\tmovieId = parseInt(movieId, 10);","\t}","\treturn this.movies.remove({","\t\tid: movieId","\t});","};","","MovieService.prototype.setTag = function(movieId, tag, value) {","\tvar updateObj = {};","\tupdateObj['tags.' + tag] = value;","\treturn this.update(movieId, updateObj);","};","","MovieService.prototype.toggleWatched = function(movieId, watched) {","\treturn this.update(movieId, {","\t\twatched: watched","\t});","};","","//HELPERS","MovieService.prototype.filmography = function(actorId) {","\tvar queryObj = {","\t\t\"casts.cast.id\": actorId","\t};","\tvar sort = {","\t\t\"release_date\": -1","\t};","\treturn this._query(queryObj, sort, 0, 2000);","};","","MovieService.prototype.genres = function() {","\treturn this.movies.aggregate(aggregates.genres());","};","","var startsWithRegex = function(search) {","\tvar pattern = \"^\" + search + \"|\\\\s\" + search;","\treturn {","\t\t\"$regex\": pattern,","\t\t\"$options\": \"i\"","\t};","};","","MovieService.prototype.search = function(search, limit) {","\tvar self = this;","\tvar searchResults = {","\t\tmovies: [],","\t\tpeople: []","\t};","","\treturn self.searchMovies(search, 5)","\t\t.then(function(movieResults) {","\t\t\tconsole.log(\"movieResults\");","","\t\t\tsearchResults.movies = movieResults;","\t\t\treturn self.searchActors(search, 5);","\t\t})","\t\t.then(function(actorResults) {","\t\t\tsearchResults.people = actorResults;","\t\t\treturn searchResults;","\t\t});","};","","MovieService.prototype.searchMovies = function(search, limit) {","\treturn this._query({","\t\ttitle: startsWithRegex(search)","\t}, null, 0, 5);","};","","MovieService.prototype.searchActors = function(search, limit) {","\tvar aggregateActions = aggregates.searchActors(search, limit);","","\treturn this.movies.aggregate(aggregateActions);","};","","MovieService.prototype.actors = function(count) {","\tvar aggregateActions = aggregates.actors(count);","","\treturn this.movies.aggregate(aggregateActions);","};","","MovieService.prototype._tagsQuery = function(tag) {","\tvar query = {};","\tquery[tag] = {","\t\t$ne: null","\t};","","\tvar options = {","\t\tsort: {}","\t};","\toptions.sort[tag] = -1;","","\tvar fields = models.ThinMovie.fields;","\treturn this._find(new mongo.MongoQuery(query, fields, options), models.ThinMovie);","};","","MovieService.prototype.favorites = function() {","\treturn this._tagsQuery(\"tags.favorited\");","};","","MovieService.prototype.queue = function() {","\treturn this._tagsQuery(\"tags.queued\");","};","","MovieService.prototype._genreStats = function(stats) {","","\treturn this.movies.aggregate(aggregates.genreStats()).then(function(genresByWatched) {","\t\tvar genres = genresByWatched.reduce(function(prev, item) {","\t\t\tif (item._id.id in prev) {","","\t\t\t}","\t\t\telse {","\t\t\t\tprev[item._id.id] = {","\t\t\t\t\tname: item._id.id,","\t\t\t\t\twatched: 0,","\t\t\t\t\tunwatched: 0","\t\t\t\t}","\t\t\t}","\t\t\tif (item._id.watched) {","\t\t\t\tprev[item._id.id].watched = item.count;","\t\t\t}","\t\t\telse {","\t\t\t\tprev[item._id.id].unwatched = item.count;","\t\t\t}","\t\t\tprev[item._id.id].count = prev[item._id.id].watched + prev[item._id.id].unwatched;","\t\t\tprev[item._id.id].watchedRatio = (prev[item._id.id].watched / prev[item._id.id].count).toFixed(4);","","\t\t\treturn prev;","\t\t}, {});","\t","\t\tvar genreArray = [];","\t\tvar keys = Object.keys(genres);","\t\tkeys.forEach(function(key){","\t\t\tgenreArray.push(genres[key]);","\t\t})","\t\t","\t\tgenreArray.sort(function(a, b){","\t\t\treturn  (a.watchedRatio < b.watchedRatio) ? 1 : -1;","\t\t});","\t\tstats.genres = genreArray;","\t\treturn stats;","\t});","};","","MovieService.prototype._movieStats = function(stats) {","\tvar allMovesQuery = {","\t\tid: {","\t\t\t$ne: null","\t\t}","\t};","\tconsole.log(this);","\treturn this.query(allMovesQuery, null, 0, 2000).then(function(allMovies) {","\t\tstats.totalCount = allMovies.length;","\t\tvar unwatched = allMovies.filter(function(movie) {","\t\t\treturn movie.watched === false;","\t\t});","\t\tstats.unwatched = unwatched.length;","\t\tstats.watched = stats.totalCount - stats.unwatched;","\t\treturn stats;","\t});","};","","MovieService.prototype._yearStats = function(stats) {","\treturn this.movies.aggregate(aggregates.years()).then(function(years) {","\t\tconsole.log(years);","\t\tstats.years = years;","\t\treturn stats;","\t});","};","","MovieService.prototype.stats = function() {","\t//total movies","\t//total watched","\t//total unwatched","\t//watched/unwatched by genre","\t//by decade","\tvar self = this;","\tvar stats = {};","","\tvar genreStats = self._genreStats(stats);","\tvar movieStats = self._movieStats(stats);","\tvar yearStats = self._yearStats(stats);","\treturn q.all([genreStats, movieStats, yearStats]).then(function() {","\t\treturn stats","\t});","","}"]},{"action":"insertText","range":{"start":{"row":284,"column":0},"end":{"row":284,"column":30}},"text":"module.exports = MovieService;"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":284,"column":0},"end":{"row":284,"column":30}},"text":"module.exports = MovieService;"},{"action":"removeLines","range":{"start":{"row":0,"column":0},"end":{"row":284,"column":0}},"nl":"\n","lines":["\"use strict\";","var mongo = require(\"droopy-mongo\"),","\tconfig = require('./config'),","\tmodels = require(\"CineProwl-Models\"),","\tq = require(\"q\"),","\taggregates = require(\"./movieservice/aggregates\"),","\tdao;","","","var MovieService = function(url) {","\turl = url || config.mongo.url;","\tdao = new mongo.MongoDao(url);","\tthis.movies = dao.collection(\"movies\");","\tthis.dao = dao;","};","","MovieService.prototype._query = function(queryObject, sort, displayed, size) {","\tvar options = {","\t\tsort: sort || {","\t\t\taddedToDb: -1","\t\t},","\t\tskip: displayed || 0,","\t\tlimit: size || 20","\t};","\tvar query = new mongo.MongoQuery(queryObject, models.ThinMovie.fields, options);","\treturn this._find(query, models.ThinMovie);","};","","MovieService.prototype._find = function(mongoQuery, Model) {","\treturn this.movies.mongoFind(mongoQuery)","\t\t.then(function(results) {","\t\t\tif (Model) {","\t\t\t\treturn results.map(function(result) {","\t\t\t\t\treturn new Model(result);","\t\t\t\t});","\t\t\t}","\t\t\telse {","\t\t\t\treturn results;","\t\t\t}","\t\t});","};","","MovieService.prototype.findOne = function(query) {","\treturn this.movies.findOne(query)","\t\t.then(function(result) {","\t\t\treturn models.FullMovie.create(result);","\t\t});","};","","MovieService.prototype.getById = function(id) {","\tif (typeof id === \"string\") {","\t\tid = parseInt(id, 10);","\t}","\treturn this.findOne({","\t\tid: id","\t});","};","","MovieService.prototype.checkIfExists = function(query) {","\treturn this.movies.checkIfExists(query);","};","","MovieService.prototype.query = function(queryObject, sort, displayed, size) {","\treturn this._query(queryObject, sort, displayed, size);","};","","//WRITE ACTIONS","MovieService.prototype.insert = function(movie) {","\tvar self = this;","\treturn this.checkIfExists({","\t\t\tid: movie.id","\t\t})","\t\t.then(function(exists) {","\t\t\tif (!exists) {","\t\t\t\tmovie.addedToDb = new Date();","\t\t\t\treturn self.movies.insert(movie)","\t\t\t\t\t.then(function(movies) {","\t\t\t\t\t\treturn movies.length ? movies[0] : null;","\t\t\t\t\t});","\t\t\t}","\t\t\telse {","\t\t\t\tthrow new Error(\"Movie already exists\");","\t\t\t}","\t\t});","};","","MovieService.prototype.insertFromMovieDb = function(movie) {","","};","","MovieService.prototype.update = function(movieId, update) {","\treturn this.movies.updateOne({","\t\tid: movieId","\t}, update);","};","","MovieService.prototype.remove = function(movieId) {","\tif (typeof movieId === \"string\") {","\t\tmovieId = parseInt(movieId, 10);","\t}","\treturn this.movies.remove({","\t\tid: movieId","\t});","};","","MovieService.prototype.setTag = function(movieId, tag, value) {","\tvar updateObj = {};","\tupdateObj['tags.' + tag] = value;","\treturn this.update(movieId, updateObj);","};","","MovieService.prototype.toggleWatched = function(movieId, watched) {","\treturn this.update(movieId, {","\t\twatched: watched","\t});","};","","//HELPERS","MovieService.prototype.filmography = function(actorId) {","\tvar queryObj = {","\t\t\"casts.cast.id\": actorId","\t};","\tvar sort = {","\t\t\"release_date\": -1","\t};","\treturn this._query(queryObj, sort, 0, 2000);","};","","MovieService.prototype.genres = function() {","\treturn this.movies.aggregate(aggregates.genres());","};","","var startsWithRegex = function(search) {","\tvar pattern = \"^\" + search + \"|\\\\s\" + search;","\treturn {","\t\t\"$regex\": pattern,","\t\t\"$options\": \"i\"","\t};","};","","MovieService.prototype.search = function(search, limit) {","\tvar self = this;","\tvar searchResults = {","\t\tmovies: [],","\t\tpeople: []","\t};","","\treturn self.searchMovies(search, 5)","\t\t.then(function(movieResults) {","\t\t\tconsole.log(\"movieResults\");","","\t\t\tsearchResults.movies = movieResults;","\t\t\treturn self.searchActors(search, 5);","\t\t})","\t\t.then(function(actorResults) {","\t\t\tsearchResults.people = actorResults;","\t\t\treturn searchResults;","\t\t});","};","","MovieService.prototype.searchMovies = function(search, limit) {","\treturn this._query({","\t\ttitle: startsWithRegex(search)","\t}, null, 0, 5);","};","","MovieService.prototype.searchActors = function(search, limit) {","\tvar aggregateActions = aggregates.searchActors(search, limit);","","\treturn this.movies.aggregate(aggregateActions);","};","","MovieService.prototype.actors = function(count) {","\tvar aggregateActions = aggregates.actors(count);","","\treturn this.movies.aggregate(aggregateActions);","};","","MovieService.prototype._tagsQuery = function(tag) {","\tvar query = {};","\tquery[tag] = {","\t\t$ne: null","\t};","","\tvar options = {","\t\tsort: {}","\t};","\toptions.sort[tag] = -1;","","\tvar fields = models.ThinMovie.fields;","\treturn this._find(new mongo.MongoQuery(query, fields, options), models.ThinMovie);","};","","MovieService.prototype.favorites = function() {","\treturn this._tagsQuery(\"tags.favorited\");","};","","MovieService.prototype.queue = function() {","\treturn this._tagsQuery(\"tags.queued\");","};","","MovieService.prototype._genreStats = function(stats) {","","\treturn this.movies.aggregate(aggregates.genreStats()).then(function(genresByWatched) {","\t\tvar genres = genresByWatched.reduce(function(prev, item) {","\t\t\tif (item._id.id in prev) {","","\t\t\t}","\t\t\telse {","\t\t\t\tprev[item._id.id] = {","\t\t\t\t\tname: item._id.id,","\t\t\t\t\twatched: 0,","\t\t\t\t\tunwatched: 0","\t\t\t\t}","\t\t\t}","\t\t\tif (item._id.watched) {","\t\t\t\tprev[item._id.id].watched = item.count;","\t\t\t}","\t\t\telse {","\t\t\t\tprev[item._id.id].unwatched = item.count;","\t\t\t}","\t\t\tprev[item._id.id].count = prev[item._id.id].watched + prev[item._id.id].unwatched;","\t\t\tprev[item._id.id].watchedRatio = (prev[item._id.id].watched / prev[item._id.id].count).toFixed(4);","","\t\t\treturn prev;","\t\t}, {});","\t","\t\tvar genreArray = [];","\t\tvar keys = Object.keys(genres);","\t\tkeys.forEach(function(key){","\t\t\tgenreArray.push(genres[key]);","\t\t})","\t\t","\t\tgenreArray.sort(function(a, b){","\t\t\treturn  (a.watchedRatio < b.watchedRatio) ? 1 : -1;","\t\t});","\t\tstats.genres = genreArray;","\t\treturn stats;","\t});","};","","MovieService.prototype._movieStats = function(stats) {","\tvar allMovesQuery = {","\t\tid: {","\t\t\t$ne: null","\t\t}","\t};","\tconsole.log(this);","\treturn this.query(allMovesQuery, null, 0, 2000).then(function(allMovies) {","\t\tstats.totalCount = allMovies.length;","\t\tvar unwatched = allMovies.filter(function(movie) {","\t\t\treturn movie.watched === false;","\t\t});","\t\tstats.unwatched = unwatched.length;","\t\tstats.watched = stats.totalCount - stats.unwatched;","\t\treturn stats;","\t});","};","","MovieService.prototype._yearStats = function(stats) {","\treturn this.movies.aggregate(aggregates.years()).then(function(years) {","\t\tconsole.log(years);","\t\tstats.years = years;","\t\treturn stats;","\t});","};","","MovieService.prototype.stats = function() {","\t//total movies","\t//total watched","\t//total unwatched","\t//watched/unwatched by genre","\t//by decade","\tvar self = this;","\tvar stats = {};","","\tvar genreStats = self._genreStats(stats);","\tvar movieStats = self._movieStats(stats);","\tvar yearStats = self._yearStats(stats);","\treturn q.all([genreStats, movieStats, yearStats]).then(function() {","\t\treturn stats","\t});","","}"]},{"action":"insertText","range":{"start":{"row":0,"column":0},"end":{"row":0,"column":40}},"text":"var startsWithRegex = function(search) {"},{"action":"insertText","range":{"start":{"row":0,"column":40},"end":{"row":1,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1,"column":0},"end":{"row":131,"column":0}},"lines":["\tvar pattern = \"^\" + search + \"|\\\\s\" + search;","\treturn {","\t\t\"$regex\": pattern,","\t\t\"$options\": \"i\"","\t};","};","","exports.genres = function() {","    return  [{","\t\t$project: {","\t\t\tgenres: 1,","\t\t\ttitle: 1","\t\t}","\t}, {","\t\t$unwind: \"$genres\"","\t}, {","\t\t$group: {","\t\t\t_id: \"$genres.name\", ","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t}","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}","\t}];","};","exports.years = function() {","\treturn [{","\t\t$project: {","\t\t\t\tyear: { $substr: [\"$release_date\", 0, 4]}","\t\t\t}","\t\t}, {","\t\t$group: {","\t\t\t_id: \"$year\",","\t\t\tcount: { $sum: 1 }","\t\t}","\t\t}, {","\t\t\t$sort: { _id: -1 }","\t}];","}","exports.genreStats = function() {","    return  [{","\t\t$project: {","\t\t\tgenres: 1,","\t\t\ttitle: 1,","\t\t\twatched: 1","\t\t}","\t}, {","\t\t$unwind: \"$genres\"","\t}, {","\t\t$group: {","\t\t\t_id: {","\t\t\t\tid: \"$genres.name\",","\t\t\t\twatched: \"$watched\"","\t\t\t},","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t}","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}","\t}];","};","","exports.actors = function (count) {","    return [{","\t\t$project: {","\t\t\t'casts.cast.name': 1,","\t\t\t'casts.cast.id': 1,","\t\t\t'casts.cast.profile_path': 1,","\t\t\ttitle: 1","\t\t}","\t}, {","\t\t$unwind: \"$casts.cast\"","\t}, {","\t\t$group: {","\t\t\t_id: {","\t\t\t\tid: \"$casts.cast.id\",","\t\t\t\tname: \"$casts.cast.name\",","\t\t\t\tprofile_path: \"$casts.cast.profile_path\"","\t\t\t},","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t},","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}","\t}, {","\t\t$limit: count || 200","\t}];","};","","exports.searchActors = function(search, limit){","    return [{","\t\t$project: {","\t\t\t'casts.cast.name': 1,","\t\t\t'casts.cast.id': 1,","\t\t\t'casts.cast.profile_path': 1,","\t\t\ttitle: 1","\t\t}","\t}, {","\t\t$unwind: \"$casts.cast\"","\t}, {","\t\t$group: {","\t\t\t_id: {","\t\t\t\tid: \"$casts.cast.id\",","\t\t\t\tname: \"$casts.cast.name\",","\t\t\t\tprofile_path: \"$casts.cast.profile_path\"","\t\t\t},","\t\t\tcount: {","\t\t\t\t$sum: 1","\t\t\t},","\t\t}","\t}, {","\t\t$match: {","\t\t\t\"_id.name\": startsWithRegex(search)","\t\t}","\t}, {","\t\t$sort: {","\t\t\tcount: -1","\t\t}","\t}, {","\t\t$limit: limit || 5","\t}];"]},{"action":"insertText","range":{"start":{"row":131,"column":0},"end":{"row":131,"column":2}},"text":"};"}]}]]},"ace":{"folds":[],"scrolltop":3819.5,"scrollleft":0,"selection":{"start":{"row":284,"column":30},"end":{"row":284,"column":30},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":253,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1411065384496,"hash":"a949747c6c5eb0e557793ecf8512a7fdec8deab3"}